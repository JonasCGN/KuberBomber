# ConfigMap para configurações do Prometheus
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      # - "first_rules.yml"
      # - "second_rules.yml"

    scrape_configs:
      # Scrape do próprio Prometheus
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      # Scrape dos pods das aplicações
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name

      # Scrape das aplicações específicas
      - job_name: 'app-services'
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: '(foo|bar|test)-service'
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: app
          - source_labels: [__address__]
            action: replace
            regex: '([^:]+):.*'
            replacement: '${1}:9898'
            target_label: __address__

---
# ServiceMonitor para as aplicações (se usando Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: app-services-monitor
  namespace: monitoring
  labels:
    app: app-monitor
spec:
  selector:
    matchLabels:
      app: foo
  namespaceSelector:
    matchNames:
      - default
  endpoints:
  - port: http
    interval: 30s
    path: /metrics
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: bar-app-monitor
  namespace: monitoring
  labels:
    app: app-monitor
spec:
  selector:
    matchLabels:
      app: bar
  namespaceSelector:
    matchNames:
      - default
  endpoints:
  - port: http
    interval: 30s
    path: /metrics
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: test-app-monitor
  namespace: monitoring
  labels:
    app: app-monitor
spec:
  selector:
    matchLabels:
      app: test
  namespaceSelector:
    matchNames:
      - default
  endpoints:
  - port: http
    interval: 30s
    path: /metrics
---
# ConfigMap com dashboard do Grafana para nossas aplicações
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  app-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Aplicações Local",
        "tags": ["kubernetes", "apps"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "CPU Usage por Aplicação",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{pod=~\"(foo|bar|test)-app-.*\"}[5m]) * 100",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "Percentage",
                "max": 100,
                "min": 0
              }
            ],
            "xAxis": {
              "show": true
            },
            "gridPos": {
              "h": 9,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Memory Usage por Aplicação",
            "type": "graph",
            "targets": [
              {
                "expr": "container_memory_usage_bytes{pod=~\"(foo|bar|test)-app-.*\"} / 1024 / 1024",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "MB",
                "min": 0
              }
            ],
            "gridPos": {
              "h": 9,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Pod Replicas por HPA",
            "type": "graph",
            "targets": [
              {
                "expr": "kube_horizontalpodautoscaler_status_current_replicas",
                "legendFormat": "{{horizontalpodautoscaler}} - Current",
                "refId": "A"
              },
              {
                "expr": "kube_horizontalpodautoscaler_status_desired_replicas",
                "legendFormat": "{{horizontalpodautoscaler}} - Desired",
                "refId": "B"
              }
            ],
            "yAxes": [
              {
                "label": "Replicas",
                "min": 0
              }
            ],
            "gridPos": {
              "h": 9,
              "w": 12,
              "x": 0,
              "y": 9
            }
          },
          {
            "id": 4,
            "title": "Request Rate por Serviço",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{service=~\"(foo|bar|test)-service\"}[5m])",
                "legendFormat": "{{service}} - {{method}} {{status_code}}",
                "refId": "A"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec",
                "min": 0
              }
            ],
            "gridPos": {
              "h": 9,
              "w": 12,
              "x": 12,
              "y": 9
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "10s"
      }
    }