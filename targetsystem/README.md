# Create Autoscaling Infrastructure to Run model validation

This is a Kubernetes infrastructure to run HPA in two deployments created in CDK to run in an AWS Academy environment.  
In this code, 9 VMs will be created to run Control plane, Worker Nodes and a Locust client, along with the network environment and an S3 bucket configured to run Kubernetes.  
This code creates the Kubernetes environment and deploys an application consisting of two deployments with HPA configured for 50% utilization.
In addition, 3 Ingress Pods are created to distribute requests between the application services.
The initial configuration creates only one initial container for each, and as demand varies, new containers are added.

The client VM is configured to use Locust to make multiple requests when the load balancer identifies that the application is working correctly.
Requests are made exponentially distributed with rates ranging from 0.005 to 0.5 req/sec.
At the end, the results are saved in Log and sent to S3 and eventually to a Google Drive address, if the service credentials are provided.


![alt text](image/autoscalingCDKTest.drawio.png "image") {width=75%}

To run your environment, it must be properly configured with the AWS client and CDK client dependencies. This project was tested with the following versions:
* Java (jdk-22.0.1)
* Maven (3.6.3)
* AWS CLI (2.15.40)
* AWS CDK (2.138.0 (build 6b41c8b))

# If the execution environment used is AWS Academy, you must use a boot version different from the default:

* `cdk bootstrap --template my-bootstrap-template.yaml`

Note: AWS Academy only allows the use of 2 availability zones and does not allow IAM modifications.

# HPA Infrastructure
Initially, the network is configured, and two availability zones will be created, one to Kubernetes cluster other to Locust Client.
The security group initially created opens all inbound and outbound ports (temporary example).  
An S3 bucket is also created, which can be accessed by the VMs.  
The internal environment setup of each VM is performed during VM creation through scripts located in the `scripts/` directory.  
The copying is done in each of the methods `createCP` and `createWN`, adding the necessary scripts.  
Modify these methods to meet your needs. If you need to exchange information between the VMs, use S3, as happens with the file generated by CP that is used by the WNs.


# How to Run

* `cdk deploy --require-approval never` deploys this stack to your default AWS account/region without asking
* `cdk destroy -f` deletes the deployment without asking

# Useful Commands:
* `mvn package`     compile and run tests
* `cdk ls`          list all stacks in the app
* `cdk synth`       emits the synthesized CloudFormation template
* `cdk deploy`      deploys this stack to your default AWS account/region
* `cdk diff`        compares deployed stack with current state
* `cdk docs`        opens CDK documentation